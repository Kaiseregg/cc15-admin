<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CC15 Admin</title>
<style>
body{font-family:system-ui;margin:0;background:#0b0f0e;color:#e8f0ee}
.wrap{max-width:1100px;margin:20px auto;padding:16px}
.card{background:#121a18;border:1px solid #23322e;border-radius:14px;padding:14px;margin:12px 0}
input,button,select{padding:10px;border-radius:10px;border:1px solid #2a3b35;background:#0e1513;color:#e8f0ee}
button{cursor:pointer} table{width:100%;border-collapse:collapse} td,th{border-bottom:1px solid #23322e;padding:8px;text-align:left}
.small{opacity:.75;font-size:12px}
</style></head><body><div class="wrap">
<h2>CombatCart 15 â€“ Admin</h2>
<div class="card">
<div class="small">Supabase URL + ANON hier eintragen (Service Role NIE ins Frontend).</div>
<input id="url" placeholder="SUPABASE_URL" style="width:48%"/> <input id="anon" placeholder="SUPABASE_ANON_KEY" style="width:48%"/>
<div style="margin-top:10px">
<input id="email" placeholder="Admin Email"/> <input id="pw" type="password" placeholder="Passwort"/>
<button id="login">Login</button> <button id="logout">Logout</button>
<span id="status" class="small"></span>
</div></div>

<div class="card"><h3>Produkte (cc15_products)</h3>
<button id="loadP">Reload</button>
<table id="pt"></table></div>

<div class="card"><h3>Slots (cc15_slots)</h3>
<button id="loadS">Reload</button>
<table id="st"></table></div>

<div class="card"><h3>Orders (cc15_orders)</h3>
<button id="loadO">Reload</button>
<table id="ot"></table></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
let sb=null;
const $=id=>document.getElementById(id);
const setStatus=t=>$("status").textContent="  "+t;

function init(){ sb = supabase.createClient($("url").value.trim(), $("anon").value.trim()); setStatus("Client ready"); }
$("url").addEventListener("change",init); $("anon").addEventListener("change",init);

$("login").onclick=async()=>{ if(!sb) init();
const {data,error}=await sb.auth.signInWithPassword({email:$("email").value.trim(),password:$("pw").value});
setStatus(error?("Login error: "+error.message):("Logged in: "+data.user.email)); };
$("logout").onclick=async()=>{ if(!sb) return; await sb.auth.signOut(); setStatus("Logged out"); };


function fmtPrice(v){
  if(v===null || v===undefined || v==="") return "";
  const n = Number(v);
  if(Number.isFinite(n)) return n.toFixed(2);
  return String(v);
}

let productsCache = [];
let productsById = {};

function productLabel(p){
  const name = (p.name_de || p.name_fr || p.id || "").toString();
  const price = (p.price_chf===null || p.price_chf===undefined) ? "" : (" CHF " + fmtPrice(p.price_chf));
  return name + price;
}

async function loadSimple(table, el, cols, orderCol){
  const q = sb.from(table).select("*").limit(200);
  if(orderCol) q.order(orderCol,{ascending:true});
  else q.order(cols[0] || "created_at",{ascending:false});
  const {data, error} = await q;
  if(error){ el.innerHTML = `<tr><td>ERROR: ${error.message}</td></tr>`; return; }
  let h = "<tr>"+cols.map(c=>`<th>${c}</th>`).join("")+"</tr>";
  for(const row of data){
    h += "<tr>"+cols.map(c=>`<td>${(row[c] ?? "")}</td>`).join("")+"</tr>";
  }
  el.innerHTML = h;
}

async function loadProducts(){
  const {data, error} = await sb.from("cc15_products")
    .select("id,name_de,name_fr,price_chf,image_path,active,created_at,updated_at")
    .order("created_at",{ascending:false})
    .limit(500);
  if(error){ $("pt").innerHTML = `<tr><td>ERROR: ${error.message}</td></tr>`; return; }

  productsCache = data || [];
  productsById = {};
  for(const p of productsCache) productsById[p.id] = p;

  let cols = ["id","name_de","name_fr","price_chf","image_path","active"];
  let h = "<tr>"+cols.map(c=>`<th>${c}</th>`).join("")+"</tr>";
  for(const p of productsCache){
    h += "<tr>"
      + `<td>${p.id}</td>`
      + `<td>${p.name_de ?? ""}</td>`
      + `<td>${p.name_fr ?? ""}</td>`
      + `<td>${fmtPrice(p.price_chf)}</td>`
      + `<td>${p.image_path ?? ""}</td>`
      + `<td>${p.active ? "true" : "false"}</td>`
      + "</tr>";
  }
  $("pt").innerHTML = h;
}

function buildProductOptions(selectedId){
  const options = [`<option value="">(leer)</option>`];
  for(const p of productsCache){
    if(p.active === false) continue; // nur aktive zeigen
    const sel = (p.id === selectedId) ? " selected" : "";
    options.push(`<option value="${p.id}"${sel}>${productLabel(p)}</option>`);
  }
  return options.join("");
}

async function updateSlot(slot_no, patch){
  const {error} = await sb.from("cc15_slots").update(patch).eq("slot_no", slot_no);
  if(error) throw error;
}

async function loadSlots(){
  if(!productsCache.length) await loadProducts();

  const {data, error} = await sb.from("cc15_slots")
    .select("slot_no,slot_active,product_id,updated_at")
    .order("slot_no",{ascending:true})
    .limit(200);
  if(error){ $("st").innerHTML = `<tr><td>ERROR: ${error.message}</td></tr>`; return; }

  let h = "<tr><th>slot_no</th><th>slot_active</th><th>product</th><th>updated_at</th></tr>";

  for(const row of data){
    const pid = row.product_id || "";
    const selectId = `pid_${row.slot_no}`;
    const chkId = `act_${row.slot_no}`;

    h += `<tr>
      <td>${row.slot_no}</td>
      <td><input type="checkbox" id="${chkId}" ${row.slot_active ? "checked" : ""}></td>
      <td>
        <select id="${selectId}" style="width:100%; padding:8px; border-radius:10px;">
          ${buildProductOptions(pid)}
        </select>
      </td>
      <td>${row.updated_at ?? ""}</td>
    </tr>`;
  }

  $("st").innerHTML = h;

  // Event handler nach Render
  for(const row of data){
    const selectEl = document.getElementById(`pid_${row.slot_no}`);
    const chkEl = document.getElementById(`act_${row.slot_no}`);

    if(selectEl){
      selectEl.addEventListener("change", async (e)=>{
        try{
          setStatus(`Saving slot ${row.slot_no}...`);
          const v = e.target.value || null;
          await updateSlot(row.slot_no, { product_id: v });
          setStatus(`Saved slot ${row.slot_no}`);
        }catch(err){
          console.error(err);
          setStatus("ERROR: " + (err?.message || err));
          // reload to reflect DB state
          await loadSlots();
        }
      });
    }

    if(chkEl){
      chkEl.addEventListener("change", async (e)=>{
        try{
          setStatus(`Saving slot ${row.slot_no}...`);
          const v = !!e.target.checked;
          await updateSlot(row.slot_no, { slot_active: v });
          setStatus(`Saved slot ${row.slot_no}`);
        }catch(err){
          console.error(err);
          setStatus("ERROR: " + (err?.message || err));
          await loadSlots();
        }
      });
    }
  }
}

$("loadP").onclick=loadProducts;
$("loadS").onclick=loadSlots;
$("loadO").onclick=()=>loadSimple("cc15_orders",$("ot"),["id","created_at","status","payment_method","location","pickup_time","customer_first_name","customer_last_name","customer_phone","total_chf"],"created_at");
</script></div></body></html>